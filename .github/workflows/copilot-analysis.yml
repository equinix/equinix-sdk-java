name: "GitHub Copilot Code Analysis"

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches:
      - main
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  copilot-analysis:
    name: Copilot Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install GitHub CLI and Copilot CLI
        run: |
          # Install GitHub CLI if not present
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh
          fi
          
          # Install Copilot CLI extension
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
          gh extension install github/gh-copilot || true

      - name: Get PR details
        id: pr-details
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER=${{ github.event.inputs.pr_number }}
          else
            PR_NUMBER=${{ github.event.number }}
          fi
          
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          
          # Get PR info
          PR_INFO=$(gh pr view $PR_NUMBER --json title,author,headRefName,baseRefName,body)
          echo "pr_title=$(echo "$PR_INFO" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "pr_author=$(echo "$PR_INFO" | jq -r '.author.login')" >> $GITHUB_OUTPUT
          echo "head_branch=$(echo "$PR_INFO" | jq -r '.headRefName')" >> $GITHUB_OUTPUT
          echo "base_branch=$(echo "$PR_INFO" | jq -r '.baseRefName')" >> $GITHUB_OUTPUT
          echo "pr_body=$(echo "$PR_INFO" | jq -r '.body')" >> $GITHUB_OUTPUT
          
          # Detect if this is an API Sync PR
          IS_API_SYNC=false
          if echo "${{ steps.pr-details.outputs.pr_title }}" | grep -i "api.*sync\|sync.*api\|spec.*update\|swagger.*update"; then
            IS_API_SYNC=true
          elif echo "${{ steps.pr-details.outputs.pr_body }}" | grep -i "swaggerhub\|api.*spec\|spec.*version"; then
            IS_API_SYNC=true
          elif echo "${{ steps.pr-details.outputs.head_branch }}" | grep -i "sync\|api\|spec"; then
            IS_API_SYNC=true
          fi
          
          echo "is_api_sync=${IS_API_SYNC}" >> $GITHUB_OUTPUT
          echo "API Sync PR detected: ${IS_API_SYNC}"

      - name: Get changed files for analysis
        id: changed-files
        run: |
          PR_NUMBER=${{ steps.pr-details.outputs.pr_number }}
          
          # Get list of changed files
          gh pr diff $PR_NUMBER --name-only > changed_files.txt
          
          # Filter for code files only (Java, Python, etc.)
          grep -E '\.(java|py|js|ts|jsx|tsx|go|rs|cpp|c|h|hpp|cs|php|rb|scala|kt)$' changed_files.txt > code_files.txt || true
          
          CHANGED_FILES_COUNT=$(wc -l < changed_files.txt | tr -d ' ')
          CODE_FILES_COUNT=$(wc -l < code_files.txt | tr -d ' ')
          
          echo "changed_files_count=${CHANGED_FILES_COUNT}" >> $GITHUB_OUTPUT
          echo "code_files_count=${CODE_FILES_COUNT}" >> $GITHUB_OUTPUT
          
          echo "Changed files: $CHANGED_FILES_COUNT"
          echo "Code files: $CODE_FILES_COUNT"

      - name: Analyze API Sync Changes
        id: api-sync-analysis
        if: steps.pr-details.outputs.is_api_sync == 'true'
        run: |
          echo "üîÑ Analyzing API Sync PR changes..."
          
          # Create API sync analysis
          cat > api_sync_summary.md << 'EOF'
          ## üîÑ API Sync PR Summary
          
          This API Sync PR was triggered by @${{ steps.pr-details.outputs.pr_author }} through GitHub Actions workflow_dispatch on $(date '+%Y-%m-%d').
          
          EOF
          
          # Try to extract version information from PR title, body, or files
          VERSION_FROM=""
          VERSION_TO=""
          
          # Check for version in PR title
          if echo "${{ steps.pr-details.outputs.pr_title }}" | grep -o "v\?[0-9]\+\.[0-9]\+\(\.[0-9]\+\)\?" | head -2; then
            VERSIONS=$(echo "${{ steps.pr-details.outputs.pr_title }}" | grep -o "v\?[0-9]\+\.[0-9]\+\(\.[0-9]\+\)\?" | head -2)
            VERSION_FROM=$(echo "$VERSIONS" | head -1 | sed 's/^v//')
            VERSION_TO=$(echo "$VERSIONS" | tail -1 | sed 's/^v//')
          fi
          
          # Check for version in PR body
          if [ -z "$VERSION_FROM" ] && echo "${{ steps.pr-details.outputs.pr_body }}" | grep -i "version.*from\|from.*version"; then
            VERSION_FROM=$(echo "${{ steps.pr-details.outputs.pr_body }}" | grep -i "version.*from\|from.*version" | grep -o "[0-9]\+\.[0-9]\+\(\.[0-9]\+\)\?" | head -1)
            VERSION_TO=$(echo "${{ steps.pr-details.outputs.pr_body }}" | grep -i "version.*to\|to.*version" | grep -o "[0-9]\+\.[0-9]\+\(\.[0-9]\+\)\?" | head -1)
          fi
          
          # Check version files
          if [ -z "$VERSION_FROM" ]; then
            if [ -f "version" ]; then
              VERSION_TO=$(cat version | tr -d '\n')
              # Try to get previous version from git
              VERSION_FROM=$(git show HEAD~1:version 2>/dev/null || echo "unknown")
            elif [ -f "pom.xml" ]; then
              VERSION_TO=$(grep -o "<version>[^<]*</version>" pom.xml | head -1 | sed 's/<[^>]*>//g' | tr -d '\n')
              VERSION_FROM=$(git show HEAD~1:pom.xml 2>/dev/null | grep -o "<version>[^<]*</version>" | head -1 | sed 's/<[^>]*>//g' | tr -d '\n' || echo "unknown")
            fi
          fi
          
          # Add version info to summary
          if [ -n "$VERSION_FROM" ] && [ -n "$VERSION_TO" ] && [ "$VERSION_FROM" != "$VERSION_TO" ]; then
            echo "This PR updates the SDK API Spec Version: from $VERSION_FROM to $VERSION_TO" >> api_sync_summary.md
            echo "" >> api_sync_summary.md
            echo "Latest Swaggerhub API Spec is fetched - version $VERSION_TO" >> api_sync_summary.md
          else
            echo "This PR updates the SDK API Spec to the latest version" >> api_sync_summary.md
            echo "" >> api_sync_summary.md
            echo "Latest Swaggerhub API Spec has been fetched" >> api_sync_summary.md
          fi
          
          echo "Patches have been applied" >> api_sync_summary.md
          echo "Generated client has been updated" >> api_sync_summary.md
          echo "" >> api_sync_summary.md
          
          # Analyze changes in SDK
          echo "## Changes in SDK" >> api_sync_summary.md
          echo "" >> api_sync_summary.md
          
          # Initialize arrays for tracking changes
          declare -A added_models
          declare -A modified_models
          declare -A removed_models
          declare -A added_apis
          declare -A modified_apis
          declare -A removed_apis
          declare -A renamed_classes
          
          # Analyze changed files
          while IFS= read -r file; do
            if [[ "$file" =~ \.java$ ]]; then
              FILE_PATH="$file"
              FILE_NAME=$(basename "$file" .java)
              
              # Check if file was added, modified, or deleted
              FILE_STATUS=$(git diff --name-status origin/${{ steps.pr-details.outputs.base_branch }}..HEAD -- "$file" 2>/dev/null | cut -f1 || echo "M")
              
              # Categorize based on file path and name
              if [[ "$file" =~ /model/ ]]; then
                case "$FILE_STATUS" in
                  "A") added_models["$FILE_NAME"]=1 ;;
                  "M") modified_models["$FILE_NAME"]=1 ;;
                  "D") removed_models["$FILE_NAME"]=1 ;;
                esac
              elif [[ "$file" =~ /api/ ]] && [[ "$FILE_NAME" =~ Api$ ]]; then
                case "$FILE_STATUS" in
                  "A") added_apis["$FILE_NAME"]=1 ;;
                  "M") modified_apis["$FILE_NAME"]=1 ;;
                  "D") removed_apis["$FILE_NAME"]=1 ;;
                esac
              fi
            fi
          done < changed_files.txt
          
          # Generate Added models section
          if [ ${#added_models[@]} -gt 0 ]; then
            echo "### Added models" >> api_sync_summary.md
            for model in "${!added_models[@]}"; do
              echo "- $model" >> api_sync_summary.md
            done
            echo "" >> api_sync_summary.md
          fi
          
          # Generate Modified models section
          if [ ${#modified_models[@]} -gt 0 ]; then
            echo "### Modified models" >> api_sync_summary.md
            for model in "${!modified_models[@]}"; do
              echo "- $model" >> api_sync_summary.md
            done
            echo "" >> api_sync_summary.md
          fi
          
          # Generate Breaking Changes section if there are removed items
          if [ ${#removed_models[@]} -gt 0 ] || [ ${#removed_apis[@]} -gt 0 ]; then
            echo "## Breaking Changes" >> api_sync_summary.md
            echo "" >> api_sync_summary.md
          fi
          
          # Modified API classes
          if [ ${#modified_apis[@]} -gt 0 ]; then
            echo "### Modified api classes" >> api_sync_summary.md
            for api in "${!modified_apis[@]}"; do
              echo "- $api" >> api_sync_summary.md
            done
            echo "" >> api_sync_summary.md
          fi
          
          # Removed API classes
          if [ ${#removed_apis[@]} -gt 0 ]; then
            echo "### Removed api classes" >> api_sync_summary.md
            for api in "${!removed_apis[@]}"; do
              echo "- $api" >> api_sync_summary.md
            done
            echo "" >> api_sync_summary.md
          fi
          
          # Removed models
          if [ ${#removed_models[@]} -gt 0 ]; then
            echo "### Removed models" >> api_sync_summary.md
            for model in "${!removed_models[@]}"; do
              echo "- $model" >> api_sync_summary.md
            done
            echo "" >> api_sync_summary.md
          fi
          
          # Try to detect renamed classes by analyzing git renames
          echo "### Renamed classes" >> api_sync_summary.md
          git diff --find-renames=50 --name-status origin/${{ steps.pr-details.outputs.base_branch }}..HEAD | grep "^R" | while read status old_file new_file; do
            if [[ "$old_file" =~ \.java$ ]] && [[ "$new_file" =~ \.java$ ]]; then
              OLD_NAME=$(basename "$old_file" .java)
              NEW_NAME=$(basename "$new_file" .java)
              echo "- $OLD_NAME -> $NEW_NAME" >> api_sync_summary.md
            fi
          done
          
          # Add footer
          echo "" >> api_sync_summary.md
          echo "---" >> api_sync_summary.md
          echo "*Auto-generated API Sync Summary - $(date '+%Y-%m-%d %H:%M:%S')*" >> api_sync_summary.md
          
          echo "api_sync_completed=true" >> $GITHUB_OUTPUT

      - name: Analyze code with Copilot
        id: copilot-analysis
        if: steps.changed-files.outputs.code_files_count > 0
        run: |
          PR_NUMBER=${{ steps.pr-details.outputs.pr_number }}
          
          echo "ü§ñ Starting Copilot analysis..."
          
          # Create analysis report
          if [ "${{ steps.pr-details.outputs.is_api_sync }}" == "true" ]; then
            # For API Sync PRs, use the structured summary
            cp api_sync_summary.md analysis_report.md
            
            # Add additional Copilot analysis for API sync
            cat >> analysis_report.md << 'EOF'
          
          ## ü§ñ GitHub Copilot Analysis
          
          ### API Changes Impact Assessment
          
          EOF
            
            # Analyze the scale of changes
            TOTAL_JAVA_FILES=$(find . -name "*.java" -path "*/src/*" | wc -l)
            CHANGED_JAVA_FILES=${{ steps.changed-files.outputs.code_files_count }}
            
            if [ "$CHANGED_JAVA_FILES" -gt 50 ]; then
              echo "‚ö†Ô∏è **Large Scale Changes**: $CHANGED_JAVA_FILES Java files modified" >> analysis_report.md
              echo "- Extensive API updates detected" >> analysis_report.md
              echo "- Recommend thorough testing of all affected endpoints" >> analysis_report.md
              echo "- Consider staged rollout for production deployment" >> analysis_report.md
            elif [ "$CHANGED_JAVA_FILES" -gt 20 ]; then
              echo "üìä **Medium Scale Changes**: $CHANGED_JAVA_FILES Java files modified" >> analysis_report.md
              echo "- Moderate API updates" >> analysis_report.md
              echo "- Verify backward compatibility" >> analysis_report.md
            else
              echo "‚úÖ **Small Scale Changes**: $CHANGED_JAVA_FILES Java files modified" >> analysis_report.md
              echo "- Limited scope API updates" >> analysis_report.md
            fi
            
            echo "" >> analysis_report.md
            
          else
            # Regular PR analysis
            cat > analysis_report.md << 'EOF'
          ## ü§ñ GitHub Copilot Code Analysis
          
          **PR:** #${{ steps.pr-details.outputs.pr_number }}
          **Title:** ${{ steps.pr-details.outputs.pr_title }}
          **Author:** ${{ steps.pr-details.outputs.pr_author }}
          **Branch:** `${{ steps.pr-details.outputs.head_branch }}` ‚Üí `${{ steps.pr-details.outputs.base_branch }}`
          
          EOF
          
            # Analyze each code file for regular PRs
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "### üìÑ Analysis of \`$file\`" >> analysis_report.md
                echo "" >> analysis_report.md
                
                # Use Copilot to explain the code changes
                echo "Analyzing $file with Copilot..."
                
                # Use gh copilot explain command
                COPILOT_EXPLANATION=""
                if command -v gh copilot &> /dev/null; then
                  # Try to get explanation from Copilot
                  COPILOT_EXPLANATION=$(gh copilot explain "$file" 2>/dev/null || echo "")
                fi
                
                if [ -n "$COPILOT_EXPLANATION" ]; then
                  echo "$COPILOT_EXPLANATION" >> analysis_report.md
                else
                  # Fallback analysis using file inspection
                  echo "**File Type:** $(file "$file" | cut -d: -f2-)" >> analysis_report.md
                  echo "**Lines:** $(wc -l < "$file" 2>/dev/null || echo "N/A")" >> analysis_report.md
                  
                  # Basic code pattern detection
                  if grep -q "class\|interface\|enum" "$file" 2>/dev/null; then
                    echo "**Contains:** Classes/Interfaces" >> analysis_report.md
                  fi
                  if grep -q "test\|Test\|@Test" "$file" 2>/dev/null; then
                    echo "**Type:** Test file" >> analysis_report.md
                  fi
                  if grep -q "public static void main" "$file" 2>/dev/null; then
                    echo "**Type:** Main class" >> analysis_report.md
                  fi
                fi
                
                echo "" >> analysis_report.md
              fi
            done < code_files.txt
          fi
          
          # Add summary section
          cat >> analysis_report.md << EOF
          
          ### üìä Summary
          
          - **Total changed files:** ${{ steps.changed-files.outputs.changed_files_count }}
          - **Code files analyzed:** ${{ steps.changed-files.outputs.code_files_count }}
          - **Analysis timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ### üîç Copilot Recommendations
          
          EOF
          
          # Get general recommendations from Copilot if available
          echo "Generating Copilot recommendations..."
          
          # Create a prompt for general code review
          REVIEW_PROMPT="Review this pull request of changed files. Please present section 'Changes in SDK' with added, modified, removed models and APIs. They should be listed and categorized by added models, added apis, renamed from one to antoher class name, modified. Please evaluate braking changes and put in different section. I just need only listed summaraize"
          
          # Use Copilot suggest if available
          SUGGESTIONS=""
          if command -v gh copilot suggest &> /dev/null; then
            SUGGESTIONS=$(echo "$REVIEW_PROMPT" | gh copilot suggest 2>/dev/null || echo "")
          fi
          
          if [ -n "$SUGGESTIONS" ]; then
            echo "$SUGGESTIONS" >> analysis_report.md
          else
            # Fallback recommendations based on file patterns
            echo "**Automated Analysis Recommendations:**" >> analysis_report.md
            echo "" >> analysis_report.md
            
            # Check for common patterns
            if grep -r "System.out.println\|console.log\|print(" . --include="*.java" --include="*.js" --include="*.py" 2>/dev/null | head -5; then
              echo "- ‚ö†Ô∏è Consider removing debug print statements before merging" >> analysis_report.md
            fi
            
            if grep -r "TODO\|FIXME\|XXX" . --include="*.java" --include="*.js" --include="*.py" 2>/dev/null | head -3; then
              echo "- üìù Address TODO/FIXME comments if possible" >> analysis_report.md
            fi
            
            if find . -name "*.java" -exec grep -l "catch.*Exception.*{[^}]*}" {} \; 2>/dev/null | head -1; then
              echo "- üîç Review exception handling in catch blocks" >> analysis_report.md
            fi
            
            echo "- ‚úÖ Consider adding unit tests for new functionality" >> analysis_report.md
            echo "- üìö Ensure proper documentation for public APIs" >> analysis_report.md
          fi
          
          cat >> analysis_report.md << EOF
          
          ---
          *Analysis generated by GitHub Copilot integration - $(date '+%Y-%m-%d %H:%M:%S')*
          EOF
          
          echo "analysis_completed=true" >> $GITHUB_OUTPUT

      - name: Create detailed diff analysis
        if: steps.copilot-analysis.outputs.analysis_completed == 'true'
        run: |
          echo "" >> analysis_report.md
          echo "### üìã Detailed Changes" >> analysis_report.md
          echo "" >> analysis_report.md
          echo "<details>" >> analysis_report.md
          echo "<summary>Click to view detailed diff analysis</summary>" >> analysis_report.md
          echo "" >> analysis_report.md
          echo "\`\`\`diff" >> analysis_report.md
          
          # Get diff with context
          gh pr diff ${{ steps.pr-details.outputs.pr_number }} | head -200 >> analysis_report.md
          
          echo "\`\`\`" >> analysis_report.md
          echo "" >> analysis_report.md
          echo "</details>" >> analysis_report.md

      - name: Post Copilot analysis as PR comment
        if: steps.copilot-analysis.outputs.analysis_completed == 'true'
        run: |
          # Post analysis as comment
          gh pr comment ${{ steps.pr-details.outputs.pr_number }} --body-file analysis_report.md

      - name: Update PR description with Copilot summary
        if: steps.copilot-analysis.outputs.analysis_completed == 'true'
        run: |
          # Get current PR description
          CURRENT_DESC=$(gh pr view ${{ steps.pr-details.outputs.pr_number }} --json body --jq '.body')
          
          # Create short summary for PR description
          SUMMARY="## ü§ñ Copilot Analysis Summary

          ‚úÖ **Analysis completed** - ${{ steps.changed-files.outputs.code_files_count }} code files analyzed
          
          üìä **Files:** ${{ steps.changed-files.outputs.changed_files_count }} changed, ${{ steps.changed-files.outputs.code_files_count }} code files
          
          üîç **Status:** Automated code review completed by GitHub Copilot
          
          > üí° See detailed analysis in PR comments below
          
          ---"
          
          # Check if summary already exists and update/add accordingly
          if echo "$CURRENT_DESC" | grep -q "## ü§ñ Copilot Analysis Summary"; then
            # Remove old summary
            NEW_DESC=$(echo "$CURRENT_DESC" | sed '/## ü§ñ Copilot Analysis Summary/,/^---$/d')
            NEW_DESC="${NEW_DESC}

          ${SUMMARY}"
          else
            # Add new summary
            if [ -n "$CURRENT_DESC" ] && [ "$CURRENT_DESC" != "null" ]; then
              NEW_DESC="${CURRENT_DESC}

          ${SUMMARY}"
            else
              NEW_DESC="$SUMMARY"
            fi
          fi
          
          # Update PR description
          echo "$NEW_DESC" > pr_description.md
          gh pr edit ${{ steps.pr-details.outputs.pr_number }} --body-file pr_description.md

      - name: Create analysis artifact
        if: steps.copilot-analysis.outputs.analysis_completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: copilot-analysis-${{ steps.pr-details.outputs.pr_number }}
          path: |
            analysis_report.md
            changed_files.txt
            code_files.txt
          retention-days: 30

      - name: Analysis summary
        if: always()
        run: |
          echo "üéâ Copilot Analysis Workflow Completed!"
          echo "=================================="
          echo "PR Number: ${{ steps.pr-details.outputs.pr_number }}"
          echo "Changed Files: ${{ steps.changed-files.outputs.changed_files_count }}"
          echo "Code Files: ${{ steps.changed-files.outputs.code_files_count }}"
          
          if [ "${{ steps.copilot-analysis.outputs.analysis_completed }}" == "true" ]; then
            echo "‚úÖ Analysis completed successfully"
            echo "üìù Check PR comments for detailed analysis"
            echo "üìã PR description updated with summary"
          else
            echo "‚ö†Ô∏è Analysis skipped (no code files found or other issue)"
          fi
