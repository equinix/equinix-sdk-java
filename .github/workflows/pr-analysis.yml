name: "PR Analysis"

on:
  workflow_run:
    workflows: ["Auto commit client updates"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-analysis:
    name: Branch File Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Run analysis and update PR
        run: |
          # Install GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
          
          # Get PR for branch
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          PR_NUMBER=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number // empty')
          
          # Run Python script and get result
          ANALYSIS_RESULT=$(python3 script/branch_file_analyzer.py)
          
          # Get current PR description
          CURRENT_DESC=$(gh pr view $PR_NUMBER --json body --jq '.body // ""')
          
          # Remove old analysis section if exists
          NEW_DESC=$(echo "$CURRENT_DESC" | sed '/## ðŸ“‹ Branch File Analysis/,/^\*Auto-generated by Branch File Analysis workflow\*$/d')
          
          # Add new analysis section
          UPDATED_DESC=$(printf "%s\n\n## ðŸ“‹ Branch File Analysis\n\n%s\n\n---\n*Auto-generated by Branch File Analysis workflow*" "$NEW_DESC" "$ANALYSIS_RESULT")
          
          # Update PR
          gh pr edit $PR_NUMBER --body "$UPDATED_DESC"
